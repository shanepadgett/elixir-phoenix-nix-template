#!/usr/bin/env bash
set -e

echo "ğŸš€ Setting up Phoenix development environment..."

# Check devenv shell
if [[ -z "$DEVENV_SHELL" ]]; then
  echo "âŒ Not in devenv shell. Run 'devenv shell' first."
  exit 1
fi

# Start services
if ! pg_isready -h localhost -p 5432 -U postgres &>/dev/null; then
  echo "ğŸ“¦ Starting PostgreSQL..."
  devenv up -d
  sleep 3
fi

# Install Hex and Rebar
echo "ğŸ“¦ Installing Hex and Rebar..."
mix local.hex --force --if-missing
mix local.rebar --force --if-missing

# Install dependencies
echo "ğŸ“¦ Installing dependencies..."
mix deps.get

# Setup assets
echo "ğŸ¨ Setting up assets..."
mix assets.setup

# Setup database
echo "ğŸ—„ï¸  Setting up database..."
mix ecto.create
mix ecto.migrate

# Compile
echo "ğŸ”¨ Compiling..."
mix compile

echo "âœ… Setup complete!"
echo "Start development: bin/dev"
